// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String     @id @default(uuid())
  email             String     @unique
  password          String?    // Nullable for OAuth users
  firstName         String?
  lastName          String?
  googleId          String?    @unique
  avatar            String?
  role              UserRole   @default(BUSINESS_USER)
  emailVerified     Boolean    @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  isActive          Boolean    @default(true)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  lastLogin         DateTime?

  // Relations
  company           Company?
  invoices          Invoice[]
  customers         Customer[]
  themes            Theme[]
  auditLogs         AuditLog[]

  @@index([email])
  @@index([googleId])
}

model Company {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  logo            String?
  email           String?
  phone           String?
  website         String?
  address         String?
  city            String?
  state           String?
  country         String?
  zipCode         String?
  taxId           String?
  registrationNo  String?

  // Branding
  primaryColor    String   @default("#3B82F6")
  secondaryColor  String   @default("#10B981")
  fontFamily      String   @default("Inter")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  invoices        Invoice[]
}

model Customer {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  email           String?
  phone           String?
  company         String?
  address         String?
  city            String?
  state           String?
  country         String?
  zipCode         String?
  taxId           String?
  notes           String?

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  invoices        Invoice[]

  @@index([userId])
  @@index([email])
}

model Invoice {
  id                String         @id @default(uuid())
  invoiceNumber     String         @unique
  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId         String
  company           Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customerId        String
  customer          Customer       @relation(fields: [customerId], references: [id])

  status            InvoiceStatus  @default(DRAFT)
  issueDate         DateTime       @default(now())
  dueDate           DateTime?

  // Amounts
  subtotal          Decimal        @default(0) @db.Decimal(10, 2)
  taxAmount         Decimal        @default(0) @db.Decimal(10, 2)
  discountAmount    Decimal        @default(0) @db.Decimal(10, 2)
  totalAmount       Decimal        @default(0) @db.Decimal(10, 2)

  // Discount
  discountType      DiscountType?
  discountValue     Decimal?       @db.Decimal(10, 2)

  // Tax
  taxRate           Decimal?       @db.Decimal(5, 2)
  taxName           String?

  // Additional Info
  notes             String?
  terms             String?
  footer            String?

  // Template
  templateId        String?
  template          InvoiceTemplate? @relation(fields: [templateId], references: [id])

  // Drive Backup
  driveFileId       String?
  lastSyncedAt      DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  items             InvoiceItem[]

  @@index([userId])
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([issueDate])
}

model InvoiceItem {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description     String
  quantity        Decimal  @db.Decimal(10, 2)
  unitPrice       Decimal  @db.Decimal(10, 2)
  amount          Decimal  @db.Decimal(10, 2)

  taxRate         Decimal? @db.Decimal(5, 2)
  taxAmount       Decimal? @db.Decimal(10, 2)

  discount        Decimal? @db.Decimal(10, 2)

  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([invoiceId])
}

model InvoiceTemplate {
  id              String   @id @default(uuid())
  userId          String

  name            String
  description     String?

  // Design
  primaryColor    String   @default("#3B82F6")
  secondaryColor  String   @default("#10B981")
  fontFamily      String   @default("Inter")
  fontSize        String   @default("12")

  // Layout
  layout          String   @default("modern")
  showLogo        Boolean  @default(true)
  showNotes       Boolean  @default(true)
  showTerms       Boolean  @default(true)

  // Default values
  defaultNotes    String?
  defaultTerms    String?
  defaultFooter   String?

  isDefault       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  invoices        Invoice[]
}

model Theme {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  mode            ThemeMode @default(LIGHT)

  primaryColor    String   @default("#3B82F6")
  secondaryColor  String   @default("#10B981")
  accentColor     String   @default("#F59E0B")
  backgroundColor String   @default("#FFFFFF")
  textColor       String   @default("#111827")

  fontFamily      String   @default("Inter")

  isActive        Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model AuditLog {
  id              String   @id @default(uuid())
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  action          String
  entity          String
  entityId        String?
  details         String?
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

// Enums

enum UserRole {
  ADMIN
  BUSINESS_USER
  ACCOUNTANT
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum ThemeMode {
  LIGHT
  DARK
}
